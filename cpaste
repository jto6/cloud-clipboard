#!/usr/bin/env bash
#
# cpaste - Cloud Paste: Paste content from a GitHub repo to clipboard
#
# Usage: cpaste [-b branch] [-l N] [-s N] [-p]
#
# Environment:
#   CLIPBOARD_REPO_PATH - Path to the local clone of your clipboard GitHub repo
#

set -euo pipefail

# Defaults
BRANCH="main"
LIST_COUNT=0
SELECT_INDEX=0
PRINT_ONLY=false
VERBOSE=false

# Parse arguments
while [[ $# -gt 0 ]]; do
	case $1 in
		-b|--branch)
			if [[ -z "${2:-}" || "$2" == -* ]]; then
				echo "Error: -b/--branch requires a branch name" >&2
				exit 1
			fi
			BRANCH="$2"
			shift 2
			;;
		-l|--list)
			if [[ -z "${2:-}" || "$2" == -* ]]; then
				echo "Error: -l/--list requires a number" >&2
				exit 1
			fi
			LIST_COUNT="$2"
			shift 2
			;;
		-s|--select)
			if [[ -z "${2:-}" || "$2" == -* ]]; then
				echo "Error: -s/--select requires a number" >&2
				exit 1
			fi
			SELECT_INDEX="$2"
			shift 2
			;;
		-p|--print)
			PRINT_ONLY=true
			shift
			;;
		-v|--verbose)
			VERBOSE=true
			shift
			;;
		-h|--help)
			echo "Usage: cpaste [-b branch] [-l N] [-s N] [-p] [-v]"
			echo ""
			echo "Paste content from GitHub repo to clipboard"
			echo ""
			echo "Options:"
			echo "  -b, --branch BRANCH   Branch to use (default: main)"
			echo "  -l, --list N          List last N clipboard entries"
			echo "  -s, --select N        Select Nth entry from history (1=latest)"
			echo "  -p, --print           Print to stdout instead of clipboard"
			echo "  -v, --verbose         Show git output"
			echo "  -h, --help            Show this help"
			echo ""
			echo "Environment:"
			echo "  CLIPBOARD_REPO_PATH   Path to local clone of clipboard repo (required)"
			echo ""
			echo "Examples:"
			echo "  cpaste                    # Paste most recent to clipboard"
			echo "  cpaste -b work            # Paste from 'work' branch"
			echo "  cpaste -l 5               # List last 5 entries"
			echo "  cpaste -s 3               # Paste 3rd most recent entry"
			echo "  cpaste -l 5 -s 2          # List 5, then paste 2nd"
			exit 0
			;;
		*)
			echo "Unknown option: $1" >&2
			exit 1
			;;
	esac
done

# Check for repo path
if [[ -z "${CLIPBOARD_REPO_PATH:-}" ]]; then
	echo "Error: CLIPBOARD_REPO_PATH environment variable not set" >&2
	echo "Set it to the path of your cloned clipboard GitHub repo" >&2
	exit 1
fi

if [[ ! -d "$CLIPBOARD_REPO_PATH/.git" ]]; then
	echo "Error: $CLIPBOARD_REPO_PATH is not a git repository" >&2
	exit 1
fi

# Detect clipboard command based on OS
set_clipboard() {
	if [[ "$OSTYPE" == "darwin"* ]]; then
		pbcopy
	elif command -v xclip &>/dev/null; then
		xclip -selection clipboard -i
	elif command -v xsel &>/dev/null; then
		xsel --clipboard --input
	elif command -v wl-copy &>/dev/null; then
		wl-copy
	else
		echo "Error: No clipboard tool found. Install xclip, xsel, or wl-copy" >&2
		exit 1
	fi
}

cd "$CLIPBOARD_REPO_PATH"

# Helper to run git commands with optional output suppression
run_git() {
	if [[ "$VERBOSE" == true ]]; then
		git "$@"
	else
		git "$@" &>/dev/null
	fi
}

# Fetch and checkout branch
run_git fetch origin || true

if git show-ref --verify --quiet "refs/remotes/origin/$BRANCH" 2>/dev/null; then
	run_git checkout "$BRANCH" || run_git checkout -b "$BRANCH" "origin/$BRANCH"
	run_git pull origin "$BRANCH" --rebase || true
elif git show-ref --verify --quiet "refs/heads/$BRANCH" 2>/dev/null; then
	run_git checkout "$BRANCH"
else
	echo "Error: Branch '$BRANCH' does not exist" >&2
	exit 1
fi

# List mode
if [[ $LIST_COUNT -gt 0 ]]; then
	echo "Last $LIST_COUNT entries on branch '$BRANCH':"
	echo ""

	# Get commits with their content previews
	i=1
	while IFS= read -r commit_line; do
		commit_hash=$(echo "$commit_line" | cut -d'|' -f1)
		commit_date=$(echo "$commit_line" | cut -d'|' -f2)
		commit_msg=$(echo "$commit_line" | cut -d'|' -f3-)

		# Get content preview from that commit
		content=$(git show "$commit_hash:clipboard.txt" 2>/dev/null | head -c 60 | tr '\n' ' ' || echo "[no content]")
		if [[ ${#content} -ge 60 ]]; then
			content="${content}..."
		fi

		echo "  [$i] $commit_date"
		echo "      $content"
		echo ""

		((i++))
	done < <(git log --format="%H|%ad|%s" --date=format:'%Y-%m-%d %H:%M' -n "$LIST_COUNT" -- clipboard.txt 2>/dev/null)

	if [[ $SELECT_INDEX -eq 0 ]]; then
		exit 0
	fi
fi

# Determine which commit to use
if [[ $SELECT_INDEX -gt 0 ]]; then
	# Get the Nth commit hash
	COMMIT_HASH=$(git log --format="%H" -n "$SELECT_INDEX" -- clipboard.txt 2>/dev/null | tail -1)
	if [[ -z "$COMMIT_HASH" ]]; then
		echo "Error: Entry $SELECT_INDEX does not exist" >&2
		exit 1
	fi
	CONTENT=$(git show "$COMMIT_HASH:clipboard.txt" 2>/dev/null)
else
	# Get current content
	if [[ ! -f clipboard.txt ]]; then
		echo "Error: No clipboard content found on branch '$BRANCH'" >&2
		exit 1
	fi
	CONTENT=$(cat clipboard.txt)
fi

if [[ -z "$CONTENT" ]]; then
	echo "Error: Clipboard content is empty" >&2
	exit 1
fi

# Output
if [[ "$PRINT_ONLY" == true ]]; then
	echo "$CONTENT"
else
	echo -n "$CONTENT" | set_clipboard
	PREVIEW=$(echo "$CONTENT" | head -c 50 | tr '\n' ' ')
	if [[ ${#CONTENT} -gt 50 ]]; then
		PREVIEW="${PREVIEW}..."
	fi
	echo "âœ“ Pasted to clipboard from branch '$BRANCH': $PREVIEW"
fi
